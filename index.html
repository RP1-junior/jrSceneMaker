<!doctype html>
<html>
<head>
<meta charset="utf-8">
<meta name="viewport" content="width=device-width, initial-scale=1">
<link rel="stylesheet" href="css/styles.css">
<title>jrSceneMaker</title>
</head>
<body>

<div id="ui">
<input type="file" id="file"><br>
<button id="translate">Translate (W)</button>
<button id="rotate">Rotate (E)</button>
<button id="scale">Scale (R)</button>
<button id="delete">Delete (Del)</button>
<button id="undo">Undo (Ctrl+Z)</button>
<button id="resetCamera">Reset Camera</button>
<br>
<label><input type="checkbox" id="snap"> Snap</label>
<input type="number" id="canvasSize" value="20" min="20" max="100"> Canvas Size<br>
</div>

<div id="sidebar">
  <strong>Models</strong>
  <ul id="modelList"></ul>
  <hr>
  <strong>Properties</strong>
  <pre id="properties"></pre>
</div>

<div id="codeBar">
  <strong>Code Editor</strong>
  <div id="jsonEditor"></div>
  <div id="jsonButtons">
    <button id="applyChanges" style="display: none;">Apply Changes</button>
    <button id="exportJson">Export JSON</button>
  </div>
</div>

<div id="helpOverlay">
  <strong>Hotkeys</strong>
  W – Move<br>
  E – Rotate<br>
  R – Scale<br>
  Q – Detach gizmo<br>
  Shift+Q – Re‑attach gizmo<br>
  F – Frame selected<br>
  Ctrl+Z – Undo<br>
  Ctrl+D – Duplicate<br>
  Alt+Drag – Duplicate while moving<br>
  Click model – Focus it<br>
  Double‑click empty – Reset to canvas<br>
  H – Toggle this help
</div>

<!-- Core Three.js -->
<script src="https://cdn.jsdelivr.net/npm/three@0.128.0/build/three.min.js"></script>
<!-- Controls & Loaders -->
<script src="https://cdn.jsdelivr.net/npm/three@0.128.0/examples/js/controls/OrbitControls.js"></script>
<script src="https://cdn.jsdelivr.net/npm/three@0.128.0/examples/js/controls/TransformControls.js"></script>
<script src="https://cdn.jsdelivr.net/npm/three@0.128.0/examples/js/loaders/GLTFLoader.js"></script>
<!-- App -->
<script src="js/main.js"></script>
<script type="module">
import {EditorView, keymap, lineNumbers, highlightActiveLine, drawSelection} from 'https://esm.sh/@codemirror/view@6';
import {EditorState} from 'https://esm.sh/@codemirror/state@6';
import {defaultHighlightStyle, syntaxHighlighting, foldGutter, foldKeymap, bracketMatching} from 'https://esm.sh/@codemirror/language@6';
import {json, jsonParseLinter} from 'https://esm.sh/@codemirror/lang-json@6';
import {defaultKeymap, history, historyKeymap} from 'https://esm.sh/@codemirror/commands@6';
import {searchKeymap, highlightSelectionMatches} from 'https://esm.sh/@codemirror/search@6';
import {closeBrackets, closeBracketsKeymap} from 'https://esm.sh/@codemirror/autocomplete@6';
import {linter, lintGutter} from 'https://esm.sh/@codemirror/lint@6';
import {oneDark} from 'https://esm.sh/@codemirror/theme-one-dark@6';

const container = document.getElementById('jsonEditor');
let initialDoc = container?.dataset?.initial || container?.textContent || '';
// Clear any existing visible text to avoid duplicate rendering next to CodeMirror
if (container) container.textContent = '';
const updateListeners = [];

const view = new EditorView({
  state: EditorState.create({
    doc: initialDoc,
    extensions: [
      EditorState.allowMultipleSelections.of(true),
      oneDark,
      lineNumbers(),
      foldGutter(),
      highlightActiveLine(),
      drawSelection(),
      bracketMatching(),
      closeBrackets(),
      highlightSelectionMatches(),
      lintGutter(),
      linter(jsonParseLinter()),
      history(),
      keymap.of([
        ...defaultKeymap,
        ...historyKeymap,
        ...searchKeymap,
        ...foldKeymap,
        ...closeBracketsKeymap
      ]),
      syntaxHighlighting(defaultHighlightStyle, {fallback: true}),
      json(),
      EditorView.updateListener.of(v => {
        if (v.docChanged) {
          const value = v.state.doc.toString();
          container.dispatchEvent(new CustomEvent('json-change', {detail: {value}}));
        }
        if (v.focusChanged && view.hasFocus) {
          container.dispatchEvent(new Event('focus'));
        }
      })
    ]
  }),
  parent: container
});

window.jsonEditorAPI = {
  getValue() { return view.state.doc.toString(); },
  setValue(text) {
    const curLen = view.state.doc.length;
    view.dispatch({changes: {from: 0, to: curLen, insert: text}});
  },
  focus() { view.focus(); }
};
// Clear the buffered initial data attribute once the editor is ready
if (container && container.dataset) delete container.dataset.initial;
</script>
</body>
</html>
